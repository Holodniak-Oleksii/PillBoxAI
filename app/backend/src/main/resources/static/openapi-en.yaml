openapi: 3.0.3
info:
  title: PillBox API
  description: REST API for managing medicine boxes and medications
  version: 1.0.0
  contact:
    name: PillBox Team
    email: support@pillbox.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8080
    description: Local development server

security:
  - bearerAuth: []

tags:
  - name: Authentication
    description: API for user registration, authorization and management
  - name: Medicine Boxes
    description: API for managing medicine boxes
  - name: Medicine Box Members
    description: API for managing medicine box participants
  - name: Pills
    description: API for managing pills and medications
  - name: AI Services
    description: AI-powered services for pill identification

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: User registration
      description: Create a new user account
      security: []
      requestBody:
        description: Registration data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid data
        '409':
          description: User already exists

  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Login to system and get JWT token
      security: []
      requestBody:
        description: Login credentials
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Successful authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials

  /auth/user/{id}:
    get:
      tags:
        - Authentication
      summary: Get user by ID
      description: Returns user information by their identifier
      parameters:
        - name: id
          in: path
          description: User ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: User not found

  /auth/user/username/{username}:
    get:
      tags:
        - Authentication
      summary: Get user by username
      description: Returns user information by their username
      parameters:
        - name: username
          in: path
          description: Username
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: User not found

  /auth/profile:
    get:
      tags:
        - Authentication
      summary: Get current user profile
      description: Returns profile information of the authenticated user based on JWT token
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized - invalid or missing JWT token
        '403':
          description: Forbidden - token is valid but user not found

  /api/medkits:
    post:
      tags:
        - Medicine Boxes
      summary: Create medicine box
      description: Create a new medicine box for specified owner
      parameters:
        - name: ownerId
          in: query
          description: Owner ID
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        description: Medicine box data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MedkitRequest'
      responses:
        '201':
          description: Medicine box successfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedkitResponse'
        '400':
          description: Invalid data
        '404':
          description: Owner not found

    get:
      tags:
        - Medicine Boxes
      summary: Get all medicine boxes for current user
      description: Returns list of all medicine boxes where the authenticated user is either the owner or a member (with any role)
      responses:
        '200':
          description: Successfully retrieved list of medicine boxes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MedkitResponse'

  /api/medkits/{id}:
    get:
      tags:
        - Medicine Boxes
      summary: Get medicine box by ID
      description: Returns medicine box information by its identifier
      parameters:
        - name: id
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Medicine box found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedkitResponse'
        '404':
          description: Medicine box not found

    put:
      tags:
        - Medicine Boxes
      summary: Update medicine box
      description: Update medicine box information
      parameters:
        - name: id
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        description: Updated medicine box data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MedkitRequest'
      responses:
        '200':
          description: Medicine box successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedkitResponse'
        '404':
          description: Medicine box not found
        '400':
          description: Invalid data

    delete:
      tags:
        - Medicine Boxes
      summary: Delete medicine box
      description: Delete medicine box by its identifier
      parameters:
        - name: id
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Medicine box successfully deleted
        '404':
          description: Medicine box not found

  /api/medkits/owner/{ownerId}:
    get:
      tags:
        - Medicine Boxes
      summary: Get medicine boxes by owner ID
      description: Returns all medicine boxes belonging to specific user
      parameters:
        - name: ownerId
          in: path
          description: Owner ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Successfully retrieved list of medicine boxes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MedkitResponse'

  /api/medkits/search:
    get:
      tags:
        - Medicine Boxes
      summary: Search medicine boxes by name
      description: Find medicine boxes whose name contains specified text
      parameters:
        - name: name
          in: query
          description: Name to search
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully found medicine boxes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MedkitResponse'

  /api/medkit-members/medkit/{medkitId}:
    post:
      tags:
        - Medicine Box Members
      summary: Add member to medicine box
      description: Add new member to specified medicine box
      parameters:
        - name: medkitId
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        description: Member data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MedkitMemberRequest'
      responses:
        '201':
          description: Member successfully added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedkitMemberResponse'
        '400':
          description: Invalid data
        '404':
          description: Medicine box or user not found

    get:
      tags:
        - Medicine Box Members
      summary: Get medicine box members
      description: Returns list of all members of specified medicine box
      parameters:
        - name: medkitId
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Successfully retrieved list of members
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MedkitMemberResponse'

  /api/medkit-members/user/{userId}:
    get:
      tags:
        - Medicine Box Members
      summary: Get user's medicine boxes
      description: Returns list of medicine boxes where user is a member
      parameters:
        - name: userId
          in: path
          description: User ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Successfully retrieved list of medicine boxes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MedkitMemberResponse'

  /api/medkit-members/medkit/{medkitId}/user/{userId}:
    get:
      tags:
        - Medicine Box Members
      summary: Get member by medicine box ID and user ID
      description: Find specific member in medicine box
      parameters:
        - name: medkitId
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
        - name: userId
          in: path
          description: User ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Member found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedkitMemberResponse'
        '404':
          description: Member not found

  /api/medkit-members/{memberId}/role:
    put:
      tags:
        - Medicine Box Members
      summary: Update member role
      description: Change member role in medicine box
      parameters:
        - name: memberId
          in: path
          description: Member ID
          required: true
          schema:
            type: integer
            format: int64
        - name: role
          in: query
          description: New member role
          required: true
          schema:
            type: string
            enum: [OWNER, EDITOR, VIEWER]
      responses:
        '200':
          description: Role successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedkitMemberResponse'
        '404':
          description: Member not found

  /api/medkit-members/{memberId}:
    delete:
      tags:
        - Medicine Box Members
      summary: Remove member
      description: Remove member from medicine box
      parameters:
        - name: memberId
          in: path
          description: Member ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Member successfully removed
        '404':
          description: Member not found

  /api/pills:
    post:
      tags:
        - Pills
      summary: Create pill
      description: Create a new pill in specified medicine box
      parameters:
        - name: medkitId
          in: query
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
        - name: createdById
          in: query
          description: User ID who creates the pill
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        description: Pill data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PillRequest'
      responses:
        '201':
          description: Pill successfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PillResponse'
        '400':
          description: Invalid data
        '404':
          description: Medicine box or user not found

    get:
      tags:
        - Pills
      summary: Get all pills
      description: Returns list of all pills
      responses:
        '200':
          description: Successfully retrieved list of pills
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PillResponse'

  /api/pills/{id}:
    get:
      tags:
        - Pills
      summary: Get pill by ID
      description: Returns pill information by its identifier
      parameters:
        - name: id
          in: path
          description: Pill ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Pill found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PillResponse'
        '404':
          description: Pill not found

    put:
      tags:
        - Pills
      summary: Update pill
      description: Update pill information
      parameters:
        - name: id
          in: path
          description: Pill ID
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        description: Updated pill data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PillRequest'
      responses:
        '200':
          description: Pill successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PillResponse'
        '404':
          description: Pill not found
        '400':
          description: Invalid data

    delete:
      tags:
        - Pills
      summary: Delete pill
      description: Delete pill by its identifier
      parameters:
        - name: id
          in: path
          description: Pill ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Pill successfully deleted
        '404':
          description: Pill not found

  /api/pills/medkit/{medkitId}:
    get:
      tags:
        - Pills
      summary: Get pills by medicine box ID
      description: Returns all pills belonging to specific medicine box
      parameters:
        - name: medkitId
          in: path
          description: Medicine box ID
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Successfully retrieved list of pills
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PillResponse'

  /api/pills/search:
    get:
      tags:
        - Pills
      summary: Search pills by name
      description: Find pills whose name contains specified text
      parameters:
        - name: name
          in: query
          description: Name to search
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successfully found pills
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PillResponse'

  /api/pills/{id}/take:
    patch:
      tags:
        - Pills
      summary: Take pill (decrease quantity)
      description: Decrease pill quantity by specified amount (symbolizes taking medication)
      parameters:
        - name: id
          in: path
          description: Pill ID
          required: true
          schema:
            type: integer
            format: int64
        - name: quantity
          in: query
          description: Number of pills to take
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Quantity successfully decreased
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PillResponse'
        '400':
          description: Invalid quantity or not enough pills available
        '404':
          description: Pill not found

  /api/pills/{id}/add:
    patch:
      tags:
        - Pills
      summary: Add quantity (increase stock)
      description: Increase pill quantity by specified amount (replenish stock)
      parameters:
        - name: id
          in: path
          description: Pill ID
          required: true
          schema:
            type: integer
            format: int64
        - name: quantity
          in: query
          description: Number of pills to add
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Quantity successfully increased
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PillResponse'
        '400':
          description: Invalid quantity
        '404':
          description: Pill not found

  /api/ai/pills/identify:
    post:
      tags:
        - AI Services
      summary: Identify pills from images
      description: Upload images of pills to identify them using AI. The AI will analyze the images and return information about detected medications.
      requestBody:
        description: Images of pills to identify
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - images
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: List of pill images to analyze
                language:
                  type: string
                  default: en
                  enum: [en, uk]
                  description: Response language (en - English, uk - Ukrainian)
      responses:
        '200':
          description: Pills successfully identified
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/IdentifiedPill'
        '400':
          description: Invalid request - no images provided or invalid format
        '500':
          description: AI service error

  /api/ai/pills/recommend:
    post:
      tags:
        - AI Services
      summary: Get AI-powered pill recommendations
      description: Get personalized medication recommendations based on symptoms or health queries. The AI analyzes the user's query and their medicine boxes to provide relevant suggestions.
      requestBody:
        description: Recommendation request with query and optional medicine box filter
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PillRecommendationRequest'
      responses:
        '200':
          description: Recommendations successfully generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PillRecommendationResponse'
        '400':
          description: Invalid request - missing or invalid query
        '401':
          description: Unauthorized - authentication required
        '500':
          description: AI service error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication token

  schemas:
    RegisterRequest:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        message:
          type: string
        token:
          type: string
        user:
          $ref: '#/components/schemas/UserResponse'

    UserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        username:
          type: string
        email:
          type: string

    MedkitRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500

    MedkitResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        description:
          type: string
        ownerId:
          type: integer
          format: int64
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MedkitMemberRequest:
      type: object
      required:
        - userId
        - role
      properties:
        userId:
          type: integer
          format: int64
        role:
          type: string
          enum: [OWNER, EDITOR, VIEWER]

    MedkitMemberResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        medkitId:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        role:
          type: string
          enum: [OWNER, EDITOR, VIEWER]
        addedAt:
          type: string
          format: date-time

    PillRequest:
      type: object
      required:
        - name
        - expiryDate
        - quantity
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Pill name
        description:
          type: string
          description: Detailed description of the pill
        expiryDate:
          type: string
          format: date
          description: Expiration date
        quantity:
          type: integer
          minimum: 0
          description: Number of pills in stock

    PillResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        medkitId:
          type: integer
          format: int64
        medkitName:
          type: string
        name:
          type: string
        description:
          type: string
        expiryDate:
          type: string
          format: date
        quantity:
          type: integer
        createdById:
          type: integer
          format: int64
        createdByUsername:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    IdentifiedPill:
      type: object
      description: Information about a pill identified by AI from an image
      properties:
        name:
          type: string
          description: Name of the identified medication
        description:
          type: string
          description: Detailed description of the medication
        expiryDate:
          type: string
          format: date
          description: Expiration date (if detected from image)
        quantity:
          type: integer
          description: Detected quantity of pills

    PillRecommendationRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          description: Health query or symptoms description to get medication recommendations
          example: "I have a headache and fever"
        medkit_id:
          type: integer
          format: int64
          description: Optional medicine box ID to filter recommendations from specific box
        language:
          type: string
          default: en
          enum: [en, uk]
          description: Response language (en - English, uk - Ukrainian)

    PillRecommendationResponse:
      type: object
      description: AI-generated medication recommendations based on user query
      properties:
        recommendation:
          type: string
          description: AI-generated recommendation text with advice and guidance
        relevant_pills:
          type: array
          items:
            $ref: '#/components/schemas/RelevantPill'
          description: List of relevant medications from user's medicine boxes
        searched_medkit_ids:
          type: array
          items:
            type: integer
            format: int64
          description: List of medicine box IDs that were searched
        disclaimer:
          type: string
          description: Medical disclaimer about the recommendations

    RelevantPill:
      type: object
      description: Medication from user's medicine box relevant to the query
      properties:
        id:
          type: integer
          format: int64
          description: Pill ID
        name:
          type: string
          description: Pill name
        description:
          type: string
          description: Pill description
        medkit_id:
          type: integer
          format: int64
          description: Medicine box ID containing this pill
        medkit_name:
          type: string
          description: Medicine box name
        similarity_score:
          type: number
          format: float
          description: Relevance score (0.0 to 1.0) indicating how well the pill matches the query
